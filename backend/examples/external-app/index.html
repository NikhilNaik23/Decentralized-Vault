<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DID OAuth Demo - External Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .auth-section {
            margin: 30px 0;
        }

        .auth-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-button svg {
            width: 24px;
            height: 24px;
        }

        .user-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
        }

        .user-info h3 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .logout-button {
            width: 100%;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s;
        }

        .logout-button:hover {
            background: #c82333;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 16px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p {
            color: #555;
            font-size: 13px;
            line-height: 1.6;
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .config-section code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
            color: #d63384;
        }

        .config-section p {
            color: #856404;
            font-size: 13px;
            margin: 8px 0;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>üîê Demo Application</h1>
            <p>External app demonstrating DID OAuth integration</p>
        </div>

        <div class="config-section">
            <h3>‚öôÔ∏è Configuration Required</h3>
            <p>Before using this demo, register an OAuth app:</p>
            <p>1. Login to Identity Vault</p>
            <p>2. Go to Developer Console</p>
            <p>3. Create new app with redirect URI: <code id="redirectUri"></code></p>
            <p>4. Copy <code>client_id</code> and <code>client_secret</code></p>
            <p>5. Update the values in the JavaScript section below</p>
        </div>

        <div class="auth-section" id="authSection">
            <button class="auth-button" id="loginButton">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
                Sign in with DID
            </button>
        </div>

        <div class="info-box">
            <h4>‚ÑπÔ∏è How it works</h4>
            <p>
                This demo application uses OAuth 2.0 to authenticate users with their Decentralized Identity (DID).
                When you click "Sign in with DID", you'll be redirected to the Identity Vault where you can authorize
                this application to access your DID information.
            </p>
        </div>

        <div id="userInfoSection" style="display: none;">
            <div class="user-info">
                <h3>‚úÖ Authenticated User</h3>
                <div id="userInfoContent"></div>
            </div>
            <button class="logout-button" id="logoutButton">Logout</button>
        </div>

        <div id="loadingSection" style="display: none;" class="loading">
            <div class="spinner"></div>
            <p>Exchanging authorization code for access token...</p>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // UPDATE THESE VALUES WITH YOUR REGISTERED APP CREDENTIALS
        const CONFIG = {
            clientId: 'YOUR_CLIENT_ID_HERE',          // Get from Identity Vault developer console
            clientSecret: 'YOUR_CLIENT_SECRET_HERE',  // Get from Identity Vault developer console
            identityVaultUrl: 'http://localhost:5000', // Your Identity Vault backend URL
            redirectUri: window.location.origin + window.location.pathname, // This page URL
            scope: 'basic_profile'
        };

        // Display redirect URI for easy copying
        document.getElementById('redirectUri').textContent = CONFIG.redirectUri;

        // ===== STATE MANAGEMENT =====
        let accessToken = localStorage.getItem('did_access_token');
        let userInfo = localStorage.getItem('did_user_info');

        // ===== INITIALIZE =====
        window.addEventListener('DOMContentLoaded', () => {
            // Check if we have an authorization code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (code) {
                // Exchange code for access token
                exchangeCodeForToken(code);
            } else if (accessToken && userInfo) {
                // Show user info if already logged in
                displayUserInfo(JSON.parse(userInfo));
            }

            // Setup event listeners
            document.getElementById('loginButton').addEventListener('click', initiateLogin);
            document.getElementById('logoutButton').addEventListener('click', logout);
        });

        // ===== LOGIN FLOW =====
        function initiateLogin() {
            // Generate state for CSRF protection
            const state = generateRandomString(32);
            sessionStorage.setItem('oauth_state', state);

            // Build authorization URL
            const params = new URLSearchParams({
                client_id: CONFIG.clientId,
                redirect_uri: CONFIG.redirectUri,
                response_type: 'code',
                scope: CONFIG.scope,
                state: state
            });

            const authUrl = `${CONFIG.identityVaultUrl}/api/oauth/authorize?${params.toString()}`;
            window.location.href = authUrl;
        }

        async function exchangeCodeForToken(code) {
            // Show loading
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            try {
                // Exchange authorization code for access token
                const response = await fetch(`${CONFIG.identityVaultUrl}/api/oauth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: CONFIG.clientId,
                        client_secret: CONFIG.clientSecret,
                        redirect_uri: CONFIG.redirectUri
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to exchange code for token');
                }

                const tokenData = await response.json();
                accessToken = tokenData.access_token;
                localStorage.setItem('did_access_token', accessToken);

                // Fetch user information
                await fetchUserInfo();

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                console.error('Error exchanging code:', error);
                alert('Authentication failed: ' + error.message);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
            }
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch(`${CONFIG.identityVaultUrl}/api/oauth/userinfo`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }

                const info = await response.json();
                localStorage.setItem('did_user_info', JSON.stringify(info));
                displayUserInfo(info);
            } catch (error) {
                console.error('Error fetching user info:', error);
                alert('Failed to fetch user information: ' + error.message);
                logout();
            }
        }

        function displayUserInfo(info) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userInfoSection').style.display = 'block';

            const content = document.getElementById('userInfoContent');
            content.innerHTML = `
                <div class="info-row">
                    <span class="info-label">DID:</span>
                    <span class="info-value">${info.did || info.sub}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Method:</span>
                    <span class="info-value">${info.did_method || 'N/A'}</span>
                </div>
                ${info.username ? `
                <div class="info-row">
                    <span class="info-label">Username:</span>
                    <span class="info-value">${info.username}</span>
                </div>
                ` : ''}
                ${info.email ? `
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${info.email}</span>
                </div>
                ` : ''}
                <div class="info-row">
                    <span class="info-label">Created:</span>
                    <span class="info-value">${new Date(info.created_at).toLocaleDateString()}</span>
                </div>
            `;
        }

        function logout() {
            localStorage.removeItem('did_access_token');
            localStorage.removeItem('did_user_info');
            accessToken = null;
            userInfo = null;

            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
        }

        // ===== UTILITIES =====
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
    </script>
</body>
</html>
